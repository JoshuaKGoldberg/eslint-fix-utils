name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}

jobs:
  release_please:
    name: Manage Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          config-file: .github/release-please/release-please-config.${{ github.ref_name }}.json
          manifest-file: .github/release-please/release-please-manifest.json

  publish:
    name: Publish Package
    if: ${{ needs.release_please.outputs.releases_created == 'true' }}
    needs: release-please
    permissions:
      contents: read
      id-token: write # Required for OIDC
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./.github/actions/prepare
      - name: Build and Publish
        run: |
          pnpm build
          pnpm publish

  post_release:
    name: Post Release Comments
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - run: echo "npm_version=$(npm pkg get version | tr -d '"')" >> "$GITHUB_ENV"
      - uses: apexskier/github-release-commenter@e7813a9625eabd79a875b4bc4046cfcae377ab34 # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          comment-template: |
            :tada: This is included in version {release_link} :tada:

            The release is available on:

            * [GitHub releases](https://github.com/JoshuaKGoldberg/eslint-fix-utils/releases/tag/{release_tag})
            * [npm package (@latest dist-tag)](https://www.npmjs.com/package/eslint-fix-utils/v/${{ env.npm_version }})

            Cheers! ðŸ“¦ðŸš€
